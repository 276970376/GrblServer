<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="./cnc-gcode.html">

<dom-module id="my-app">
	<style is="custom-style">
		:host {
			cursor: default;
			display: block;
			width: 1280px;
			height: 100%;
			margin: 0 auto;
		}

		paper-tabs {
			background-color: #00bcd4;
			color: #fff;
		}

		paper-tabs iron-icon {
			margin: 5px;
		}

		paper-button {
			font-size: 12px;
			background: var(--paper-grey-100);
		}

		table tr {
		}

		.coords-container {
			padding: 16px 0;
			position: relative;
		}

		.coords {
			font-size: 20px;
			line-height: 20px;
			color: #333;
			width: 100%;
		}

		.coords th,
		.coords td {
			padding: 5px 10px;
		}

		.coords th.heading {
			text-align: left;
			font-size: 12px;
			color: #fff;
			background-color: #00bcd4;
			font-weight: normal;
		}

		.coords .machine {
			font-size: 14px;
		}

		.coords .machine th ,
		.coords .machine td {
			padding: 2px 10px;
		}

		.coords iron-icon {
			width: 24px;
			height: 24px;
		}

		.coords .axis {
			padding: 0 30px;
		}

		.coords .reset {
			width: 32px;
			padding: 0;
		}

		.coords .number {
			text-align: right;
			width: 100px;
		}

		.coords paper-button {
			font-size: 16px;
			background: #fff;
		}

		.macros {
			padding: 16px;
		}

		.jog {
			font-size: 12px;
		}

		.jog table {
			width: 300px;
			margin: 8px auto;
		}

		.jog iron-icon {
			width: 32px;
			height: 32px;
		}

		.jog paper-button {
			white-space: nowrap;
			background: #fff;
		}

		.axis-label {
			color: #999;
		}

		.status-container {
			width: 800px;
			margin: 0 auto;
		}

		.status {
		}

		.status div {
			display: inline-block;
		}

		.status .title {
			height: 100%;
			padding: 12px;
			color: #fff;
			background: var(--paper-blue-grey-300);
			font-size: 14px;
		}

		.status .title.Idle {
		}

		.status .title.Alarm {
			background: var(--paper-red-800);
		}

		.status .title.Run {
			background: var(--paper-yellow-800);
		}

		.status .title.Hold {
			background: var(--paper-yellow-800);
		}

		.status .title.Home {
			background: var(--paper-yellow-800);
		}

		.status .title.Door {
			background: var(--paper-yellow-800);
		}

		.status .title.Check {
		}

		.status .title iron-icon {
			padding: 5px;
			margin-top: -2px;
		}

		.status .value {
		}

		paper-material {
			margin: 10px;
		}

		paper-tabs[align-bottom] {
			box-shadow: 0px -2px 6px rgba(0, 0, 0, 0.15);
		}


		#command-history {
			overflow-y: scroll;
			font-family: monospace;
			font-size: 12px;
			line-height: 12px;
		}

		#command-history .line {
			font-size: 12px;
			padding: 5px;
		}

		#command-history .line:nth-child(even) {
			background: var(--paper-grey-100);
		}
		
		#command-history .line:nth-child(odd) {
		}

		.action-resume {
			background: var(--paper-green-800);
			color: #fff;
		}

		.action-pause {
			background: var(--paper-yellow-800);
			color: #fff;
		}

		.action-reset {
			background: var(--paper-red-800);
			color: #fff;
		}

		.gcode {
			font-family: monospace;
			font-size: 12px;
			line-height: 12px;
		}

		.gcode .line {
			padding: 6px;
		}

		.gcode .line:nth-child(even) {
			background: var(--paper-grey-100);
		}

		.gcode .line:nth-child(odd) {
		}

		.gcode .line.sent:nth-child(even) {
			background: var(--paper-grey-500);
			color: var(--paper-grey-800);
		}

		.gcode .line.sent:nth-child(odd) {
			background: var(--paper-grey-400);
			color: var(--paper-grey-800);
		}

		[disabled] {
			opacity: 0.3;
		}

		.feedback {
			padding: 0 16px;
			font-size: 80%;
		}

		.actions {
			padding: 6px;
		}

		.preset-positions {
			padding: 16px;
		}

		#settings {
		}

		#settings .body {
			margin: 0;
			padding: 0;
		}

		#settings .body > iron-pages > * {
			padding: 0 24px;
		}

		#settings .body > iron-pages > .macros {
			padding: 0;
		}

		#settings .body > iron-pages > .macros > * {
			padding: 0 24px;
		}

		#settings .body > iron-pages > .macros .list {
		}

		#settings .body > iron-pages > .macros .edit {
			background: #efefef;
			border-left: 1px solid #ccc;
		}

		@media (max-width: 1280px) {

			:host {
				font-size: 12px;
				padding-bottom: 100px;
			}

			paper-button {
				font-size: 10px;
			}

			paper-button iron-icon {
				width: 16px;
				height: 16px;
				margin-top: -2px;
			}

			.status-container {
				width: 100%;
			}

			.status .title {
				padding: 6px;
				font-size: 10px;
			}

			.coords-container {
				width: 100%;
			}

			.coords {
				font-size: 11px;
				line-height: 11px;
			}

			.coords th,
			.coords td {
				padding: 0px 5px;
			}

			.coords iron-icon {
				width: 16px;
				height: 16px;
			}

			.coords paper-button {
				font-size: 10px;
				background: #fff;
			}

			.jog iron-icon {
				width: 24px;
				height: 24px;
			}

			paper-material.actions {
				position: fixed;
				bottom: 0;
				width: 100%;
				left: 0;
				margin: 0;
				background: #fff;
				box-sizing: border-box;
				z-index: 999;

				box-shadow: 0 0 8px 0 rgba(0, 0, 0, 0.32);
			}

			paper-material.actions[disabled] {
				opacity: 1;
				/* display: none; */
			}

			.command-container {
				margin-bottom: 100px;
			}
		}
	</style>
	<template>
		<div class="layout vertical" style="height: 100%">
			<div class="layout horizontal wrap">
				<paper-material class="flex-9 self-stretch status layout horizontal" elevation="1">
					<div class="flex">
						<div class$="{{sprintf('title %s', status.state)}}">
							<iron-icon icon="{{conditional(isConnected, 'image:flash-on', 'image:flash-off')}}"></iron-icon>
							<span>{{status.state}}</span>
						</div>
						<div class="feedback">
							<template is="dom-if" if="{{equals(status.state, 'Alarm')}}">
								<div class="" style="font-weight: bold">
									<iron-icon icon="icons:error" style="color: #cc0000; margin-right: 10px; margin-top: -4px"></iron-icon>
									Grbl is locked. Unlock by:
								</div>
								<paper-button noink on-tap="commandUnlock">
									<iron-icon icon="icons:lock-open"></iron-icon>
									Unlock
								</paper-button>
								or
								<paper-button noink on-tap="commandHoming">
									<iron-icon icon="icons:home"></iron-icon>
									Homing
								</paper-button>
							</template>
							<template is="dom-if" if="{{error}}">
								<div class="" style="font-weight: bold">
									<iron-icon icon="icons:error" style="color: #cc0000; margin-right: 10px; margin-top: -4px"></iron-icon>
									<span>{{error}}</span>
								</div>
							</template>
						</div>
					</div>
				</paper-material>

				<paper-material class="actions" disabled$="{{equals(status.state, 'Unknown')}}">
					<template is="dom-if" if="{{equals(status.state, 'Hold')}}">
						<paper-button noink class="action-resume" on-tap="commandResume">
							<iron-icon icon="av:play-arrow"></iron-icon>
							Resume
						</paper-button>
					</template>
					<template is="dom-if" if="{{!equals(status.state, 'Hold')}}">
						<paper-button noink class="action-pause" on-tap="commandPause">
							<iron-icon icon="av:pause"></iron-icon>
							Pause
						</paper-button>
					</template>
					<paper-button noink class="action-reset" on-tap="commandReset">
						<iron-icon icon="icons:cancel"></iron-icon>
						Reset
					</paper-button>

					<paper-button noink class="action-open-setting" on-tap="openSettings" style="margin-left: 16px">
						<iron-icon icon="icons:settings"></iron-icon>
						Settings
					</paper-button>
				</paper-material>
			</div>

			<div class="layout horizontal wrap">
				<paper-material class$="{{conditional(positioningSystem, 'coords-container machine', 'coords-container working')}}">
					<table class="coords">
						<tr>
							<th colspan="3" class="heading">Work</th>
						</tr>

						<tr>
							<th class="axis">X</th>
							<td class="number">{{formatCoords(status.workingPosition.x)}}</td>
							<td class="reset"><paper-button noink data-axis="x" on-tap="resetToZero" disabled="{{isBatchMode}}"><iron-icon icon="settings-backup-restore"></iron-icon></paper-button></td>
						</tr>
						<tr>
							<th class="axis">Y</th>
							<td class="number">{{formatCoords(status.workingPosition.y)}}</td>
							<td class="reset"><paper-button noink data-axis="y" on-tap="resetToZero" disabled="{{isBatchMode}}"><iron-icon icon="settings-backup-restore"></iron-icon></paper-button></td>
						</tr>
						<tr>
							<th class="axis">Z</th>
							<td class="number">{{formatCoords(status.workingPosition.z)}}</td>
							<td class="reset"><paper-button noink data-axis="z" on-tap="resetToZero" disabled="{{isBatchMode}}"><iron-icon icon="settings-backup-restore"></iron-icon></paper-button></td>
						</tr>

						<tr>
							<th colspan="3" class="heading">Machine</th>
						</tr>

						<tr class="machine">
							<th class="axis">X</th>
							<td class="number">{{formatCoords(status.machinePosition.x)}}</td>
							<td class="reset"></td>
						</tr>
						<tr class="machine">
							<th class="axis">Y</th>
							<td class="number">{{formatCoords(status.machinePosition.y)}}</td>
							<td class="reset"></td>
						</tr>
						<tr class="machine">
							<th class="axis">Z</th>
							<td class="number">{{formatCoords(status.machinePosition.z)}}</td>
							<td class="reset"></td>
						</tr>
					</table>
				</paper-material>

				<paper-material class="flex macros" disabled$="{{equals(status.state, 'Unknown')}}">
					<div class="layout horizontal">
						<div class="jog relative">
							<table>
								<tr>
									<td>
									</td>
									<td>
										<paper-button noink disabled="{{isBatchMode}}" raised data-axis="y" data-direction="+1" ><iron-icon icon="hardware:keyboard-arrow-up"></iron-icon>
											<div class="axis-label">+Y</div>
										</paper-button>
									</td>
									<td>
									</td>
									<td>
										<paper-button noink disabled="{{isBatchMode}}" raised data-axis="z" data-direction="+1" ><iron-icon icon="hardware:keyboard-arrow-up"></iron-icon>
											<div class="axis-label">+Z</div>
										</paper-button>
									</td>
								</tr>
								<tr>
									<td>
										<paper-button noink disabled="{{isBatchMode}}" raised data-axis="x" data-direction="-1" ><iron-icon icon="hardware:keyboard-arrow-left"></iron-icon> 
											<span class="axis-label" style="margin-right: 10px">-X</span>
										</paper-button>
									</td>
									<td>
									</td>
									<td>
										<paper-button noink disabled="{{isBatchMode}}" raised data-axis="x" data-direction="+1" >
											<span class="axis-label" style="margin-left: 10px">+X</span>
											<iron-icon icon="hardware:keyboard-arrow-right"></iron-icon></paper-button>
									</td>
									<td>
									</td>
								</tr>
								<tr>
									<td>
									</td>
									<td>
										<paper-button noink disabled="{{isBatchMode}}" raised data-axis="y" data-direction="-1" >
											<div class="axis-label">-Y</div>
											<iron-icon icon="hardware:keyboard-arrow-down"></iron-icon></paper-button>
									</td>
									<td>
									</td>
									<td>
										<paper-button noink disabled="{{isBatchMode}}" raised data-axis="z" data-direction="-1" >
											<div class="axis-label">-Z</div>
											<iron-icon icon="hardware:keyboard-arrow-down"></iron-icon></paper-button>
									</td>
								</tr>
							</table>
							<div>
								<paper-menu-button style="padding: 0" vertical-align="bottom" horizontal-align="right" disabled="{{isBatchMode}}">
									<paper-button noink class="dropdown-trigger" style="text-transform: none">
										<iron-icon icon="image:straighten"></iron-icon>
										Step: <span>{{jogStep}}</span> mm
									</paper-button>
									<paper-menu class="dropdown-content">
										<template is="dom-repeat" items="{{jogStepList}}">
											<paper-item on-tap="changeStep" data-value$="{{item}}">Step: <span>{{item}}</span> mm</paper-item>
										</template>
									</paper-menu>
								</paper-menu-button>
							</div>
						</div>
						<div class="flex">
							<div class="preset-positions">
								<paper-button noink on-tap="commandHoming" disabled="{{isBatchMode}}">
									<iron-icon icon="icons:home"></iron-icon>
									Homing
								</paper-button>
								<paper-button noink on-tap="commandReturn" disabled="{{isBatchMode}}">
									<iron-icon icon="hardware:keyboard-return"></iron-icon>
									Return to zero
								</paper-button>
								<template is="dom-repeat" items="{{settings.macros}}">
									<paper-button on-tap="settingsDoMacro" data-item$="{{item.id}}" disabled="{{isBatchMode}}">
										<iron-icon icon="icons:extension"></iron-icon>
										<span>{{item.label}}</span>
									</paper-button>
								</template>
							</div>
						</div>

					</div>
				</paper-material>

			</div>


			<div class="flex layout horizontal wrap">
				<paper-material class="flex command-container layout vertical" disabled$="{{equals(status.state, 'Unknown')}}">
					<paper-tabs selected="{{commandTab}}" noink no-slide>
						<paper-tab>
							<iron-icon icon="hardware:keyboard"></iron-icon>
							Command Line
						</paper-tab>
						<paper-tab>
							<iron-icon icon="icons:file-upload"></iron-icon>
							Upload File
						</paper-tab>
					</paper-tabs>
					<iron-pages class="flex layout vertical" selected="{{commandTab}}">
						<div class="flex layout vertical" style="height: 100%">
							<div style="padding: 0 16px">
								<paper-input disabled="{{isBatchMode}}" label="Command" placeholder="G28" on-keydown="commandAny"></paper-input>
							</div>
							<div class="flex" style="position: relative">
								<div style="position: absolute; top: 0; left: 16px; right: 16px; bottom: 0; overflow-y: scroll">
									<div id="command-history" style="height: 100%">
										<template is="dom-repeat" items="{{commandHistory}}">
											<div class="line">
												<span>{{item.prefix}}</span>
												<span>{{item.value}}</span>
											</div>
										</template>
									</div>
								</div>
							</div>
						</div>
						<div class="flex layout vertical" style="padding: 16px">
							<template is="dom-if" if="{{!gcode}}">
								<div id="upload-file" style="self-center">
									<div style="padding: 60px 20px; font-size: 200%; font-weight: bold; color: #999; text-align: center; border: 5px solid #999" >
										Drag and Drop here
										<div style="font-size: 50%">or click to open select dialogue</div>
									</div>
									<input type="file" style="visibility: hidden"></input>
								</div>
							</template>
							<template is="dom-if" if="{{gcode}}">
								<div class="layout horizontal">
									<paper-input class="flex" label="Uploaded File" value="{{gcode.name}}" readonly></paper-input>
									<template is="dom-if" if="{{!isBatchMode}}">
										<div style="padding-top: 20px; margin: 0 10px 0 -10px; color: #666">
											<paper-icon-button icon="icons:clear" on-tap="commandClearUploadedFile" title="Clear uploaded file"></paper-icon-button>
										</div>
									</template>
									<paper-input class="flex" label="Uploaded" value="{{strftime('%Y-%m-%d %H:%M', gcode.createdTime)}}" readonly></paper-input>
									<paper-input class="flex" label="Started" value="{{strftime('%Y-%m-%d %H:%M', gcode.startedTime)}}" readonly></paper-input>
								</div>
								<!-- div class="layout horizontal">
									<paper-input class="flex" label="Uploaded Total" value="{{bind(gcode.total, gcode.*)}}" readonly></paper-input>
									<paper-input class="flex" label="Sent" value="{{bind(gcode.sent.length, gcode.*)}}" readonly></paper-input>
									<paper-input class="flex" label="Remain" value="{{bind(gcode.remain.length, gcode.*)}}" readonly></paper-input>
								</div -->
								<template is="dom-if" if="{{gcode.startedTime}}">
									<paper-progress value="{{progress(gcode.sent.length, gcode.remain.length, gcode.*)}}" style="width: 100%"></paper-progress>
								</template>
								<template is="dom-if" if="{{!gcode.startedTime}}">
									<div style="vertical-align: baseline; text-align: right">
										<paper-button noink class="action-resume" on-tap="commandRunGCode" disabled="{{!equals(status.state, 'Idle')}}">
											<iron-icon icon="av:play-arrow"></iron-icon>
											Execute
										</paper-button>
									</div>
								</template>
								<div class="flex gcode" style="overflow-y: scroll; position: relative;">
									<div id="gcode-list" style="position: absolute; top: 10px; left: 0; right: 0; bottom: 0;">
										<template is="dom-repeat" items="{{gcode.sent}}">
											<div class="line sent">{{item}}</div>
										</template>
										<template is="dom-repeat" items="{{gcode.remain}}">
											<div class="line remain">{{item}}</div>
										</template>
									</div>
								</div>
							</template>
						</div>
					</iron-pages>
				</paper-material>
				<paper-material class="flex preview layout vertical">
					<div class="flex relative">
						<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0">
							<cnc-gcode id="viewer" style="width: 100%; height: 100%"></cnc-gcode>
						</div>
					</div>
				</paper-material>
			</div>
		</div>


		<paper-dialog id="alarm" modal style="min-width: 400px;">
			<h2>ALARM</h2>
			<p>{{lastAlarm}}</p>
			<div class="buttons">
				<paper-button noink dialog-confirm autofocus>Tap me to close</paper-button>
			</div>
		</paper-dialog>

		<paper-dialog id="upload" modal style="min-width: 400px;">
			<h2>{{upload.status}}</h2>
			<p>
				<span>{{upload.name}}</span>:
				<span>{{upload.size}}</span> bytes
			</p>
			<p>
				<paper-progress value="{{upload.progress}}" style="width: 100%"></paper-progress>
			</p>
		</paper-dialog>

		<paper-dialog id="settings" modal style="min-width: 900px">
			<div class="layout horizontal" style="margin: 0">
				<h2 class="flex" style="height: 48px; line-height: 48px; text-align: left; margin-left: -24px; padding-left: 24px">Settings</h2>
				<paper-tabs class="flex-5" selected="{{settingsTab}}" noink no-slide style="margin-right: -24px;">
					<paper-tab>Macros</paper-tab>
					<paper-tab>Connection</paper-tab>
					<paper-tab>Grbl</paper-tab>
				</paper-tabs>
			</div>
			<div class="body">
				<iron-pages class="flex layout vertical" selected="{{settingsTab}}" style="min-height: 400px">
					<!-- Macros -->
					<div class="macros flex layout horizontal">
						<div class="list flex">
							<div class="layout horizontal">
								<h3 class="flex-3"> Current List </h3>
								<div class="flex-1" style="text-align: right; padding: 5px">
									<paper-icon-button icon="icons:add-box" on-tap="settingsAddMacro"></paper-icon-button>
								</div>
							</div>

							<template is="dom-repeat" items="{{settings.macros}}">
								<paper-button on-tap="settingsEditMacro" data-item$="{{item.id}}">{{item.label}}</paper-button>
							</template>

						</div>

						<div class="edit flex">
							<template is="dom-if" if="{{currentEdittingMacro}}">
								<div class="layout horizontal">
									<h3 class="flex">Edit</h3>
									<div class="flex" style="text-align: right; padding: 5px">
										<paper-icon-button icon="icons:cancel" on-tap="settingsRemoveMacro"></paper-icon-button>
									</div>
								</div>
								<paper-input label="Label" placeholder="" value="{{currentEdittingMacro.label}}"></paper-input>
								<paper-textarea label="Code" placeholder="" rows="5" value="{{currentEdittingMacro.gcode}}"></paper-textarea>
								<paper-button on-tap="settingsSaveMacro">Save</paper-button>
							</template>
						</div>
					</div>
					<!-- /Macros -->

					<!-- Connection -->
					<div class="flex vertical">
						<h3>Grbl Server</h3>
						<paper-input label="Server Address" placeholder="ws://" value="{{settings.grblServer.address}}" disabled="{{settings.grblServer.addressAuto}}"></paper-input>
						<paper-checkbox checked="{{settings.grblServer.addressAuto}}">Automatic</paper-checkbox>
					</div>
					<!-- /Connection -->

					<!-- Grbl -->
					<div class="flex vertical">
						<h3>Edit Grbl Settings</h3>
						Not implemented
					</div>
					<!-- /Grbl -->
				</iron-pages>

				<iron-localstorage
					name="grbl-server-client-settings"
					value="{{settings}}"
					on-iron-localstorage-load-empty="initializeDefaultSettings"
					></iron-localstorage>
			</div>

			<div class="buttons">
				<paper-button noink dialog-confirm autofocus>Close</paper-button>
			</div>
		</paper-dialog>

		<paper-toast id="feedback" duration="10000"></paper-toast>
		<paper-toast id="gcodeDone" text="G-code Sent" duration="10000"></paper-toast>

	</template>
</dom-module>

<script src="../bower_components/strftime/strftime.js"></script>
<script src="../bower_components/sprintf/dist/sprintf.min.js"></script>
<script src="app.js"></script>
